# ğŸ› ï¸ Agent ê°œë°œ ê°€ì´ë“œ

## âš ï¸ í•µì‹¬ ì£¼ì˜ì‚¬í•­

### 1. ìƒíƒœ(State) ê´€ë¦¬ ê·œì¹™

#### âœ… ì˜¬ë°”ë¥¸ ë°©ì‹
```python
def my_agent_node(state):
    """AgentëŠ” dictë¥¼ ë°˜í™˜í•´ì•¼ í•¨"""
    
    # stateì—ì„œ ì½ê¸°
    user_query = state.get("user_query", "")
    constraints = state.get("constraints", {})
    
    # ì²˜ë¦¬ ë¡œì§
    result = do_something(user_query, constraints)
    
    # dict ë°˜í™˜ (ì—…ë°ì´íŠ¸í•  í‚¤ë§Œ)
    return {
        "my_result": result,
        "logs": [f"[{datetime.now()}] my_agent: ì™„ë£Œ"]
    }
```

#### âŒ ì˜ëª»ëœ ë°©ì‹
```python
def my_agent_node(state):
    # ì˜ëª»: stateë¥¼ ì§ì ‘ ìˆ˜ì •
    state["my_result"] = result  # âŒ
    state.my_result = result     # âŒ
    
    # ì˜ëª»: state ê°ì²´ ë°˜í™˜
    return state  # âŒ
```

---

### 2. TypedDict vs Pydantic ì´ìŠˆ

í˜„ì¬ `AgentState`ëŠ” **TypedDict**ì…ë‹ˆë‹¤.

```python
# âœ… ì˜¬ë°”ë¥¸ ì ‘ê·¼
value = state.get("key")
value = state["key"]

# âŒ ì˜ëª»ëœ ì ‘ê·¼
value = state.key  # AttributeError!
```

#### Pydantic ëª¨ë¸ ì‚¬ìš© ì‹œ
```python
from contracts import ContextJSON

def context_agent_node(state):
    # Pydantic ëª¨ë¸ ìƒì„±
    context = ContextJSON(...)
    
    # dictë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
    return {
        "context_json": context.dict()  # âœ…
        # "context_json": context       # âŒ Pydantic ê°ì²´ ê·¸ëŒ€ë¡œëŠ” ì•ˆë¨
    }
```

---

### 3. ë³‘ë ¬ ì²˜ë¦¬ ê·œì¹™

#### logs í•„ë“œëŠ” íŠ¹ë³„í•¨
```python
# graph.pyì—ì„œ ì •ì˜
class AgentState(TypedDict):
    logs: Annotated[list[str], operator.add]  # ë³‘ë ¬ ì²˜ë¦¬ìš©
```

```python
# âœ… ì˜¬ë°”ë¥¸ ë¡œê·¸ ì¶”ê°€
return {
    "logs": ["ìƒˆ ë¡œê·¸ 1", "ìƒˆ ë¡œê·¸ 2"]  # ìë™ìœ¼ë¡œ ê¸°ì¡´ logsì— ì¶”ê°€ë¨
}

# âŒ ì˜ëª»ëœ ë°©ì‹
logs = state.get("logs", [])
logs.append("ìƒˆ ë¡œê·¸")  # ë³‘ë ¬ ì‹¤í–‰ ì‹œ ì¤‘ë³µ/ëˆ„ë½ ê°€ëŠ¥
return {"logs": logs}
```

#### ë‹¤ë¥¸ í•„ë“œëŠ” ë®ì–´ì“°ê¸°
```python
# context_jsonì€ ë§ˆì§€ë§‰ ê°’ìœ¼ë¡œ ë®ì–´ì”€
return {
    "context_json": new_context  # ì´ì „ ê°’ ë¬´ì‹œ
}
```

---

### 4. ì—ëŸ¬ ì²˜ë¦¬

#### ê° Agentì—ì„œ ë°©ì–´ ì½”ë“œ ì‘ì„±
```python
def context_agent_node(state):
    try:
        constraints = state.get("constraints", {})
        
        # í•„ìˆ˜ ê°’ ê²€ì¦
        if not constraints.get("store_id"):
            logger.warning("store_id ëˆ„ë½")
            return {
                "context_json": None,
                "logs": ["[ERROR] store_id í•„ìˆ˜"]
            }
        
        # ì •ìƒ ì²˜ë¦¬
        context = _build_context_json(state)
        
        return {
            "context_json": context.dict(),
            "logs": [f"[{datetime.now()}] context_agent: ì™„ë£Œ"]
        }
        
    except Exception as e:
        logger.error(f"Context Agent ì˜¤ë¥˜: {e}")
        return {
            "context_json": None,
            "logs": [f"[ERROR] {str(e)}"]
        }
```

---

### 5. None ì²´í¬ í•„ìˆ˜

```python
def merge_supervisor_node(state):
    context = state.get("context_json")
    situation = state.get("situation_json")
    resource = state.get("resource_json")
    
    # âœ… None ì²´í¬
    if not context:
        logger.warning("Context ëˆ„ë½")
        # ê¸°ë³¸ê°’ ì‚¬ìš© ë˜ëŠ” ì—ëŸ¬ ì²˜ë¦¬
    
    # âœ… ì•ˆì „í•œ ì ‘ê·¼
    metrics = context.get("metrics", {}) if context else {}
    kpi = metrics.get("kpi", {})
```

---

### 6. ê·¸ë˜í”„ êµ¬ì¡° ìˆ˜ì • ì‹œ

#### graph.py ìˆ˜ì •
```python
# ìƒˆ ë…¸ë“œ ì¶”ê°€
def new_agent_node(state):
    return {"new_field": "value"}

def build_graph():
    g = StateGraph(AgentState)
    
    # ë…¸ë“œ ë“±ë¡
    g.add_node("new_agent", new_agent_node)
    
    # ì—£ì§€ ì—°ê²°
    g.add_edge("context_agent", "new_agent")
    g.add_edge("new_agent", "merge_supervisor")
    
    return g.compile()
```

#### AgentStateì— í•„ë“œ ì¶”ê°€
```python
class AgentState(TypedDict):
    # ê¸°ì¡´ í•„ë“œ
    user_query: str
    
    # ìƒˆ í•„ë“œ ì¶”ê°€
    new_field: str | None  # None í—ˆìš© íƒ€ì…
```

---

### 7. DB ì—°ë™ ì‹œ ì£¼ì˜ì‚¬í•­

```python
def context_agent_node(state):
    constraints = state.get("constraints", {})
    store_id = constraints.get("store_id")
    
    # âœ… DB ì—°ê²° ê´€ë¦¬
    try:
        conn = get_db_connection()
        
        # ì¿¼ë¦¬ ì‹¤í–‰
        df = pd.read_sql(
            "SELECT * FROM store_metrics WHERE store_id = %s",
            conn,
            params=(store_id,)
        )
        
        # ë°ì´í„° ì²˜ë¦¬
        result = process_dataframe(df)
        
        return {"context_json": result}
        
    except Exception as e:
        logger.error(f"DB ì˜¤ë¥˜: {e}")
        return {
            "context_json": None,
            "logs": [f"[ERROR] DB ì—°ê²° ì‹¤íŒ¨: {str(e)}"]
        }
        
    finally:
        if conn:
            conn.close()  # ë°˜ë“œì‹œ ì—°ê²° ì¢…ë£Œ
```

---

### 8. LLM í†µí•© ì‹œ

```python
from langchain_google_genai import ChatGoogleGenerativeAI

def strategy_supervisor_node(state):
    user_query = state.get("user_query", "")
    
    # âœ… LLM ì´ˆê¸°í™” (ìºì‹± ê³ ë ¤)
    llm = ChatGoogleGenerativeAI(
        model="gemini-2.0-flash-exp",
        temperature=0.7
    )
    
    # í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    prompt = f"""
    ì‚¬ìš©ì ì§ˆë¬¸: {user_query}
    
    ì´ ì§ˆë¬¸ì˜ ì˜ë„ë¥¼ ë¶„ì„í•˜ì„¸ìš”.
    - strategy: ì „ëµ ìˆ˜ë¦½
    - comparison: ë¹„êµ ë¶„ì„
    """
    
    try:
        response = llm.invoke(prompt)
        intent = response.content.strip()
        
        return {
            "intent": intent,
            "logs": [f"LLM ì˜ë„ ë¶„ì„: {intent}"]
        }
        
    except Exception as e:
        logger.error(f"LLM ì˜¤ë¥˜: {e}")
        # í´ë°±: ê·œì¹™ ê¸°ë°˜
        intent = "strategy" if "ì „ëµ" in user_query else "comparison"
        return {
            "intent": intent,
            "logs": [f"[FALLBACK] ê·œì¹™ ê¸°ë°˜ ì˜ë„: {intent}"]
        }
```

---

### 9. í…ŒìŠ¤íŠ¸ ì‘ì„±

```python
# tests/test_context_agent.py
import pytest

def test_context_agent_basic():
    """ê¸°ë³¸ ë™ì‘ í…ŒìŠ¤íŠ¸"""
    state = {
        "user_query": "í…ŒìŠ¤íŠ¸",
        "constraints": {
            "store_id": "S123",
            "start_date": "2025-01-01",
            "end_date": "2025-01-31"
        },
        "logs": []
    }
    
    result = context_agent_node(state)
    
    # ê²€ì¦
    assert result is not None
    assert "context_json" in result
    assert result["context_json"] is not None
    assert len(result["logs"]) > 0

def test_context_agent_missing_store_id():
    """store_id ëˆ„ë½ ì‹œ ì²˜ë¦¬"""
    state = {
        "user_query": "í…ŒìŠ¤íŠ¸",
        "constraints": {},  # store_id ì—†ìŒ
        "logs": []
    }
    
    result = context_agent_node(state)
    
    # ì—ëŸ¬ ì²˜ë¦¬ í™•ì¸
    assert "context_json" in result
    # ê¸°ë³¸ê°’ ë˜ëŠ” None ë°˜í™˜ í™•ì¸
```

---

### 10. ì„±ëŠ¥ ìµœì í™”

#### ìºì‹±
```python
from functools import lru_cache

@lru_cache(maxsize=100)
def get_market_data(market_id: str):
    """ì‹œì¥ ë°ì´í„° ìºì‹±"""
    # DB ì¡°íšŒ (ìºì‹±ë¨)
    return query_market_data(market_id)
```

#### ë¹„ë™ê¸° ì²˜ë¦¬
```python
import asyncio

async def context_agent_node_async(state):
    """ë¹„ë™ê¸° ë²„ì „"""
    # ì—¬ëŸ¬ DB ì¿¼ë¦¬ë¥¼ ë³‘ë ¬ë¡œ
    store_data, market_data = await asyncio.gather(
        fetch_store_data_async(store_id),
        fetch_market_data_async(market_id)
    )
    
    return {"context_json": combine(store_data, market_data)}
```

---

### 11. ë¡œê¹… Best Practices

```python
from loguru import logger

def my_agent_node(state):
    # ì…ë ¥ ë¡œê¹…
    logger.info(f"Agent ì‹œì‘: {state.get('user_query')}")
    
    # ì¤‘ìš” ë‹¨ê³„ ë¡œê¹…
    logger.debug(f"constraints: {state.get('constraints')}")
    
    # ê²½ê³ 
    if not some_condition:
        logger.warning("íŠ¹ì • ì¡°ê±´ ë¯¸ì¶©ì¡±")
    
    # ì—ëŸ¬
    try:
        result = do_something()
    except Exception as e:
        logger.error(f"ì²˜ë¦¬ ì‹¤íŒ¨: {e}", exc_info=True)
        raise
    
    # ì™„ë£Œ ë¡œê¹…
    logger.info("Agent ì™„ë£Œ")
    
    return {"result": result}
```

---

### 12. ë²„ì „ ê´€ë¦¬

#### ìŠ¤í‚¤ë§ˆ ë²„ì „
```python
class ContextJSON(BaseModel):
    # ë²„ì „ ê´€ë¦¬
    contract_version: str = Field("ctx.v1", description="ìŠ¤í‚¤ë§ˆ ë²„ì „")
    
    # í–¥í›„ ctx.v2ë¡œ ì—…ê·¸ë ˆì´ë“œ ì‹œ í˜¸í™˜ì„± ìœ ì§€
```

#### í•˜ìœ„ í˜¸í™˜ì„±
```python
def _build_context_json(state) -> ContextJSON:
    # v1, v2 ëª¨ë‘ ì§€ì›
    version = state.get("schema_version", "v1")
    
    if version == "v1":
        return _build_context_v1(state)
    elif version == "v2":
        return _build_context_v2(state)
    else:
        logger.warning(f"Unknown version: {version}, using v1")
        return _build_context_v1(state)
```

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

Agent ê°œë°œ/ìˆ˜ì • ì‹œ í™•ì¸ì‚¬í•­:

- [ ] dictë¥¼ ë°˜í™˜í•˜ëŠ”ê°€? (state ê°ì²´ ë°˜í™˜ ê¸ˆì§€)
- [ ] stateëŠ” `.get()` ë˜ëŠ” `[]`ë¡œ ì ‘ê·¼í•˜ëŠ”ê°€?
- [ ] Pydantic ëª¨ë¸ì€ `.dict()`ë¡œ ë³€í™˜í–ˆëŠ”ê°€?
- [ ] None ì²´í¬ë¥¼ í–ˆëŠ”ê°€?
- [ ] ì—ëŸ¬ ì²˜ë¦¬ê°€ ë˜ì–´ ìˆëŠ”ê°€?
- [ ] ë¡œê·¸ë¥¼ ë‚¨ê¸°ëŠ”ê°€?
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í–ˆëŠ”ê°€?
- [ ] graph.pyì— ë…¸ë“œë¥¼ ë“±ë¡í–ˆëŠ”ê°€?
- [ ] AgentStateì— í•„ìš”í•œ í•„ë“œë¥¼ ì¶”ê°€í–ˆëŠ”ê°€?

---

## ğŸ› ë””ë²„ê¹… íŒ

### 1. ë¡œê·¸ ë ˆë²¨ ì¡°ì •
```python
# agents/__init__.py ë˜ëŠ” ê° íŒŒì¼ ìƒë‹¨
from loguru import logger
import sys

logger.remove()
logger.add(sys.stderr, level="DEBUG")  # ëª¨ë“  ë¡œê·¸ ì¶œë ¥
```

### 2. State ì¶œë ¥
```python
def debug_node(state):
    """ë””ë²„ê·¸ìš© ë…¸ë“œ"""
    print("="*60)
    print("í˜„ì¬ State:")
    print("="*60)
    for key, value in state.items():
        if isinstance(value, dict):
            print(f"{key}: [dict with {len(value)} keys]")
        elif isinstance(value, list):
            print(f"{key}: [list with {len(value)} items]")
        else:
            print(f"{key}: {value}")
    
    return {}  # ìƒíƒœ ë³€ê²½ ì—†ìŒ
```

### 3. Jupyterì—ì„œ ë‹¨ê³„ë³„ ì‹¤í–‰
```python
# test_agents.ipynb í™œìš©
state = create_test_state("í…ŒìŠ¤íŠ¸ ì§ˆë¬¸")

# ë‹¨ê³„ë³„ ì‹¤í–‰
result1 = context_agent_node(state)
print(result1)

state.update(result1)
result2 = situation_agent_node(state)
print(result2)
```

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- [LangGraph ê³µì‹ ë¬¸ì„œ](https://langchain-ai.github.io/langgraph/)
- [Pydantic ë¬¸ì„œ](https://docs.pydantic.dev/)
- [TypedDict ë¬¸ì„œ](https://docs.python.org/3/library/typing.html#typing.TypedDict)

---

## ğŸš¨ ìì£¼ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜

### 1. `'dict' object has no attribute 'X'`
**ì›ì¸**: TypedDictë¥¼ Pydanticì²˜ëŸ¼ ì ‘ê·¼  
**í•´ê²°**: `state.X` â†’ `state.get("X")` ë˜ëŠ” `state["X"]`

### 2. `Can receive only one value per step`
**ì›ì¸**: ë³‘ë ¬ ë…¸ë“œê°€ ê°™ì€ í•„ë“œ ì—…ë°ì´íŠ¸  
**í•´ê²°**: `Annotated[list, operator.add]` ì‚¬ìš© ë˜ëŠ” í•„ë“œ ë¶„ë¦¬

### 3. `KeyError: 'context_json'`
**ì›ì¸**: ì´ì „ ë…¸ë“œê°€ ì‹¤í–‰ ì•ˆë˜ê±°ë‚˜ ì—ëŸ¬ ë°œìƒ  
**í•´ê²°**: `.get()` ì‚¬ìš© + None ì²´í¬

### 4. JSON serialization ì˜¤ë¥˜
**ì›ì¸**: Pydantic ê°ì²´ë¥¼ ì§ì ‘ ë°˜í™˜  
**í•´ê²°**: `.dict()` ë˜ëŠ” `.model_dump()` ì‚¬ìš©

---

## ğŸ’¡ ê°œë°œ ì›Œí¬í”Œë¡œìš°

1. **ì„¤ê³„**: ì–´ë–¤ ë°ì´í„°ë¥¼ ë°›ê³  ë°˜í™˜í• ì§€ ëª…í™•íˆ
2. **ìŠ¤í‚¤ë§ˆ**: contractsì— í•„ìš”í•œ ìŠ¤í‚¤ë§ˆ ì •ì˜
3. **êµ¬í˜„**: Agent í•¨ìˆ˜ ì‘ì„± (dict ë°˜í™˜!)
4. **í…ŒìŠ¤íŠ¸**: Jupyterì—ì„œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
5. **í†µí•©**: graph.pyì— ë…¸ë“œ ë“±ë¡
6. **ê²€ì¦**: ì „ì²´ ê·¸ë˜í”„ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
7. **ìµœì í™”**: ì„±ëŠ¥ ê°œì„  ë° ì—ëŸ¬ ì²˜ë¦¬ ê°•í™”

---

ì´ ê°€ì´ë“œë¥¼ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ë‘ê³  ì°¸ê³ í•˜ì„¸ìš”!